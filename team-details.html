---
layout: page
title: View Team Details
permalink: /team-details/
---
<div class="container">
  <div class="row">
    <div class="col-md-12">
      <form id="reportForm" class="form-horizontal">
        <fieldset>

          <div class="row">
            <div class="col-md-12">
              <div class="form-group">
                <div class="col-md-4">
                  <select id="teams" name="team_id" class="form-control">
                    <option value="-99">- Select a team -</option>
                  </select>
                </div>
                <div class="col-md-8 panel panel-default" style="margin:0;">
                  <div class="panel-body" style="padding:8px;">
                    <h4 class="pull-left" style="margin:0px 15px 5px 0px;">Matches Played: <span id="team-play-count" class="label label-default"></span></h4>
                    <h4 class="pull-left" style="margin:0px 15px 5px 0px;">Points/Match: <span id="team-avg-points" class="label label-default"></span></h4>
                    <h4 class="pull-left" style="margin:0px 15px 5px 0px;">Rank: <span id="team-rank" class="label label-default"></span></h4>
                    <h4 class="pull-left" style="margin:0px 15px 5px 0px;">Ranking Score: <span id="team-rankscore" class="label label-default"></span></h4>
                    <h4 class="pull-left" style="margin:0px 15px 5px 0px;">Scale/Challenge: <span id="team-scalechallenge" class="label label-default"></span></h4>
                    <h4 class="pull-left" style="margin:0px 15px 5px 0px;">Goals: <span id="team-goals" class="label label-default"></span></h4>
                    <h4 class="pull-left" style="margin:0px 15px 5px 0px;" data-toggle="tooltip" data-placement="top" title="Offensive Power Rating: expected points contribution per match">OPRS: <span id="team-oprs" class="label label-default"></span></h4>
                    <h4 class="pull-left" style="margin:0px 15px 5px 0px;" data-toggle="tooltip" data-placement="top" title="Calculated Contribution to Winning Margin">CCWMS: <span id="team-ccwms" class="label label-default"></span></h4>
                    <h4 class="pull-left" style="margin:0px 15px 5px 0px;" data-toggle="tooltip" data-placement="top" title="Defensive Power Rating">DPRS: <span id="team-dprs" class="label label-default"></span></h4>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12">
              <div id="scores-viz" style="min-width: 310px; height: 350px; margin: 0 auto"></div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col-md-12">
              <div id="scouting-viz" style="min-width: 310px; height: 350px; margin: 0 auto"></div>
            </div>
          </div>

        </fieldset>
      </form>
    </div>
  </div>
</div>

<script>
$(function() {
  // build bootstrap tooltips
  $('[data-toggle="tooltip"]').tooltip()

  // fetch team data
  $("#teams").change("click", function(ev) {
    // determine report to fetch
    var selectedVal = this.value;

    // if selecting the placeholder, just return
    if(selectedVal === '-99') return;

    // fetch scoring data
    ParadoxScout.onTeamScoreAdded(null, selectedVal, 'value', function(teamScoresSnapshot) {
      // if nothing returned
      if(!teamScoresSnapshot.exists()) return;

      var team = teamScoresSnapshot.val();
      var data = team.scores;

      //$.getJSON("{{ site.url }}/test-data/sample-event-scores-by-team.json", function(data) {
      // add  match_key to each match score object and add to array
      var scores = $.map(data, function(v, k) {
        v.match_key = k
        return v;
      });

      // sort scores by match time asc
      scores.sort(function(a, b) {
        return parseFloat(a.match_time) - parseFloat(b.match_time);
      });

      var matchKeys = [];
      var scoringData = {};
      var scoringDataCumulative = {}

      var visualizedScores = { 
        'totalPoints' : { display_order: 1, visible: true }, 
        'teleopPoints': { display_order: 2, visible: true }, 
        'teleopBoulderPoints' : { display_order: 3, visible: true }, 
        'teleopBouldersHigh': { display_order: 4 }, 
        'teleopBouldersLow' : { display_order: 5 }, 
        'teleopCrossingPoints': { display_order: 6, visible: true }, 
        'autoPoints': { display_order: 7, visible: true },
        'autoBoulderPoints' : { display_order: 8, visible: true }, 
        'autoBouldersHigh': { display_order: 9 }, 
        'autoBouldersLow' : { display_order: 10 }, 
        'autoCrossingPoints': { display_order: 11, visible: true }, 
      }; 

      $.each(scores, function(index, s) {
        // add timeKey to x-axis array
        matchKeys.push(s.match_key);

        //add score aggregation to y-axis array
        $.each(s, function(k, v) {
          var category = visualizedScores[k];
          if (!category) return;

          if(!(k in scoringData)) {
            var isVisibleByDefault = category.visible || false;

            scoringData[k] = { name: k, data: [], display_order: category.display_order, visible: isVisibleByDefault };
            scoringDataCumulative[k] = { name: k, data: [], display_order: category.display_order };
          }

          // show average over time
          var currentSum = scoringDataCumulative[k].data[scoringDataCumulative[k].data.length - 1] || 0
          scoringDataCumulative[k].data.push(currentSum + v);
          scoringData[k].data.push(Math.round((currentSum + v)/(index + 1) *100)/100);

          // fyi - to instead show data accumulation over time
          // scoringData[k].data.push(currentSum + v);
        })
      });

      // prepare serries array
      var series = $.map(scoringData, function(v, k) { return v; });
      series.sort(function(a, b) {
        return parseFloat(a.display_order) - parseFloat(b.display_order);
      });

      // console.log(matchKeys);
      // console.log(scoringData);
      // console.log(series);

      // update chart
      scoresVizOptions.xAxis.categories = matchKeys;
      scoresVizOptions.series = series;
      var chart = new Highcharts.Chart(scoresVizOptions);

      // summarize key metrics: get point averages
      var pointsPerMatch = scoringDataCumulative.totalPoints.data[scoringDataCumulative.totalPoints.data.length-1] / scores.length;

      $('#team-avg-points').text(Math.round(pointsPerMatch *100)/100);
      $('#team-oprs').text(Math.round(team.oprs *100)/100);
      $('#team-ccwms').text(Math.round(team.ccwms *100)/100);
      $('#team-dprs').text(Math.round(team.dprs *100)/100);
      $('#team-rank').text(team.ranking);
      $('#team-rankscore').text(team.rankingScore);
      $('#team-scalechallenge').text(team.rankingScaleChallenge);
      $('#team-goals').text(team.rankingGoals);
      $('#team-play-count').text(team.rankingPlayed);
    });

    // fetch scouting data
    ParadoxScout.getScoutingReports(null, selectedVal, 'value', function(teamReportsSnapshot) {
      // if nothing returned
      if(!teamReportsSnapshot) return;

      var data = teamReportsSnapshot.val();
      //console.log(reports);

      // get scouting data for selected team
      //$.getJSON("{{ site.url }}/test-data/sample-scouting-reports-by-team.json", function(data) {
      var scores = {};

      // 1. aggregate results by HOUR
      $.each(data, function(rptKey, r) {
        // get timestamp by whole hour, this will be the key for the x-axis
        var timeKey = new Date(moment(new Date(r.scored_at)).format('MM/DD/YYYY, h:00:00 a')).getTime().toString();

        // add timeKey if does not exist and set up ratings to visualize
        if(!(timeKey in scores)) {
          scores[timeKey] = { 
            team_key: r.team_id,
            timeKey: timeKey,
            rating_scoring_high_goal: { score: 0, count: 0, display_order: 4}, 
            rating_scoring_low_goal: { score: 0, count: 0, display_order: 5}, 
            rating_scoring_tower_climb: { score: 0, count: 0, display_order: 6}, 
            rating_scoring_tower_capture: { score: 0, count: 0, display_order: 7}, 
            rating_overall: { score: 0, count: 0, display_order: 1}, 
            rating_overall_robot_stability: { score: 0, count: 0, display_order: 2}, 
            rating_overall_alliance_coop: { score: 0, count: 0, display_order: 3}, 
            rating_obstacle_cheval_de_frise: { score: 0, count: 0, display_order: 8}, 
            rating_obstacle_drawbridge: { score: 0, count: 0, display_order: 9}, 
            rating_obstacle_low_bar: { score: 0, count: 0, display_order: 10}, 
            rating_obstacle_moat: { score: 0, count: 0, display_order: 11}, 
            rating_obstacle_portcullis: { score: 0, count: 0, display_order: 12}, 
            rating_obstacle_ramparts: { score: 0, count: 0, display_order: 13}, 
            rating_obstacle_rock_wall: { score: 0, count: 0, display_order: 14}, 
            rating_obstacle_rough_terrain: { score: 0, count: 0, display_order: 15}, 
            rating_obstacle_sally_port: { score: 0, count: 0, display_order: 16}
          };
        } 

        // iterate thru ratings and aggregate any visualizable ratings defined above
        $.each(r, function(scoutingKey, scoutingVal) {
          if(scoutingKey.startsWith('rating') && (scoutingKey in scores[timeKey])) {
            scores[timeKey][scoutingKey].score = scores[timeKey][scoutingKey].score += (parseInt(scoutingVal) || 0);
            scores[timeKey][scoutingKey].count = scores[timeKey][scoutingKey].count += ( scoutingVal ? 1 : 0 );
          }
        });
      });

      // 2. sort by date asc
      var scoresByTimeInterval = $.map(scores, function(v, k) { return v ;});

      scoresByTimeInterval.sort(function(a, b) {
        return parseFloat(a.timeKey) - parseFloat(b.timeKey);
      });

      // 3. build arrays for x-axis (time) and y-axis (avg. rating)
      var reportTimes = [];
      var scoreAggregations = {};

      $.each(scoresByTimeInterval, function(index, s) {
        // add timeKey to x-axis array
        reportTimes.push(s.timeKey);

        // add score aggregation to y-axis array
        $.each(s, function(k, v) {
          if(!k.startsWith('rating')) return;

          // Connor wanted this and he always gets what he wants
          var visibleByDefault = true; //k.startsWith('rating_overall') || k.startsWith('rating_scoring');

          if(!(k in scoreAggregations)) scoreAggregations[k] = { name: k, data: [], display_order: v.display_order, visible:visibleByDefault };

          scoreAggregations[k].data.push(v.count == 0 ? null : v.score/v.count);
        })
      })

      // 4. sort series by scoring display_order
      var series = $.map(scoreAggregations, function(v, k) { return v; });
      series.sort(function(a, b) {
        return parseFloat(a.display_order) - parseFloat(b.display_order);
      });

      // console.log(reportTimes);
      // console.log(series);

      // 5. update chart
      scoutingVizOptions.xAxis.categories = reportTimes;
      scoutingVizOptions.series = series;
      var chart = new Highcharts.Chart(scoutingVizOptions);

    });
  });


  // *** onload ***
  
  // 1. configure scoring visualization
  var scoresVizOptions = {
    chart: {
      renderTo: 'scores-viz', type: 'line', zoomType: 'xy'
    },
    title: {
      text: 'Scoring Trend Analysis', x: -20 //center
    },
    xAxis: {
      categories: [],
      labels: {
        formatter: function() { 
          var matchName = this.value.substring(this.value.indexOf('_') + 1);
          return matchName;
        }
      }
    },
    yAxis: {
      title: { text: 'Score' },
      min: 0,
      max: 125,
      plotLines: [{ value: 0, width: 1, color: '#808080' }]
    },
    legend: {
      layout: 'vertical',
      align: 'right',
      verticalAlign: 'middle',
      borderWidth: 0,
      labelFormatter: function() { return this.name.replace('rating_', '').replace(/_/g, ' ');}
    },
    plotOptions: { 
      series: { connectNulls: true } 
    },
    tooltip: { 
      formatter: function() { return this.series.name.replace('rating_', '').replace(/_/g, ' ') + ': ' + this.y;}
    },
    series: []
  };

  // 2. configure scouting reports visualization
  var scoutingVizOptions = {
    chart: {
      renderTo: 'scouting-viz', type: 'line'
    },
    title: {
      text: 'Scouting Report Rating Analysis', x: -20 //center
    },
    xAxis: {
      categories: [],
      labels: {
        formatter: function() { 
          return moment(new Date(parseFloat(this.value))).format('MMM Do hh:mm[-]hh[:59] a');
        }
      }
    },
    yAxis: {
      title: { text: 'Rating' },
      min: 1,
      max: 5,
      plotLines: [{ value: 0, width: 1, color: '#808080' }]
    },
    legend: {
      layout: 'vertical',
      align: 'right',
      verticalAlign: 'middle',
      borderWidth: 0,
      labelFormatter: function() { return this.name.replace('rating_', '').replace(/_/g, ' ');}
    },
    plotOptions: { 
      series: { connectNulls: true } 
    },
    tooltip: { 
      formatter: function() { return this.series.name.replace('rating_', '').replace(/_/g, ' ') + ' avg.: ' + this.y;}
    },
    series: []
  };

  // 3. build teams dropdown
  $('.loaderImage').show();
  
  ParadoxScout.buildTeamsDropdown($('#teams'), null, function(error) {

    $('.loaderImage').hide();

    if (error) {
      AppUtility.showErrorMsg("An error occurred!", error);
    }
    else {
      // if a team key is included in querystring, select that team
      var selectedTeamKey = AppUtility.getUrlParameter('team_id');
      if(selectedTeamKey && $("#teams option[value='" + selectedTeamKey + "']").length > 0) {
        $('#teams').val(selectedTeamKey);
        $('#teams').change();
      }
    }
  });

});
</script>
